# 백엔드 개발 로드맵

코어(Domain Layer)에서 바깥(Presentation Layer)으로 확장하며, 각 단계마다 유닛 테스트로 검증한다.

---

## Phase 0: 프로젝트 스캐폴딩

프로젝트 구조, 빌드 설정, 테스트 환경을 구성한다.

**작업 내용**
- Node.js + TypeScript 프로젝트 초기화 (`tsconfig.json`, `package.json`)
- 디렉토리 구조 생성 (Hexagonal Architecture 기반)
- 테스트 프레임워크 설정 (Vitest 또는 Jest)
- ESLint + Prettier 설정
- 경로 alias 설정 (`@domain/`, `@application/`, `@infrastructure/`, `@presentation/`)

**디렉토리 구조**
```
src/
├── domain/
│   ├── models/          # Aggregate, Entity
│   ├── value-objects/   # Value Object (branded types)
│   ├── events/          # Domain Event 정의
│   ├── services/        # Domain Service
│   └── ports/           # Repository & Infrastructure Port 인터페이스
├── application/
│   ├── use-cases/       # UseCase 구현
│   ├── event-handlers/  # Event Handler
│   └── dtos/            # Command, Query DTO
├── infrastructure/
│   ├── repositories/    # Repository Adapter (in-memory, DB)
│   ├── clients/         # GitClient, AgentClient, McpClient, FileSystem Adapter
│   ├── events/          # EventPublisher Adapter
│   └── config/          # 설정, 환경변수
├── presentation/
│   ├── rest/            # REST Controller, DTO, Validation
│   └── websocket/       # WebSocket Handler
└── shared/
    ├── errors/          # 공통 에러 클래스
    └── utils/           # 유틸리티
tests/
├── unit/
├── integration/
├── e2e/
└── fixtures/            # Builder, Fake, Spy
```

**완료 기준**: `npm run build` 성공, `npm test` (빈 테스트) 성공

---

## Phase 1: Value Object & Enum

도메인의 가장 작은 단위인 값 객체와 열거형을 정의한다. 외부 의존성이 전혀 없는 순수 타입이다.

**작업 내용**

1-1. **ID 타입** (branded type)
- `GitId`, `McpServerId`, `WorkflowTemplateId`, `WorkflowId`, `WorkId`, `TaskId`, `ReportId`, `WorkTreeId`, `WorkflowSpaceId`, `WorkSpaceId`, `CheckpointId`
- 각 ID에 `generate()` (UUID v4), `create(value)` (기존 값으로 생성) 팩토리

1-2. **도메인 값 타입**
- `GitUrl` — git 프로토콜 검증 (`/^(https?:\/\/|git:\/\/|ssh:\/\/|git@).+\.git$/`)
- `BranchName` — git ref 규칙 검증
- `CommitHash` — 40자 hex 검증
- `IssueKey` — configurable 패턴 (기본: JIRA 형식)
- `AgentModel` — allowlist 기반 검증

1-3. **복합 값 객체**
- `GitRef` (gitId + baseBranch)
- `BranchStrategy` (workBranch)
- `ReportOutline` (sections: Section[])
- `Section` (title + description)
- `McpServerRef` (mcpServerId + envOverrides)
- `WorkTreeTrackingInfo` (workTreeId? + status)

1-4. **Enum 정의**
- `WorkflowStatus`, `WorkStatus`, `AgentStatus`, `TaskStatus`, `QueryStatus`
- `ReportGenerationStatus`, `ReportStatus`, `WorkTreeStatus`, `ResourceStatus`
- `McpTransportType`, `LinkType`

**테스트**
- 각 Value Object: 유효 값 생성 성공, 무효 값 생성 실패 (경계값 포함)
- Enum: 모든 값 존재, 유효하지 않은 값 거부
- 예: `GitUrl.create("https://github.com/org/repo.git")` → 성공
- 예: `GitUrl.create("not-a-url")` → `InvalidValueObjectError`
- 예: `CommitHash.create("abc")` → 실패 (40자 미만)

---

## Phase 2: Domain Event 정의

모든 도메인 이벤트의 타입과 페이로드를 정의한다. 이벤트는 순수 데이터 객체이며 로직이 없다.

**작업 내용**

2-1. **DomainEvent 기반 타입**
```typescript
interface DomainEvent {
  readonly id: string;
  readonly type: string;
  readonly occurredAt: Date;
  readonly correlationId?: string;
}
```

2-2. **이벤트 정의** (33+ 이벤트)
- Git: `GitCreated`, `GitDeleted`
- McpServer: `McpServerRegistered`, `McpServerUnregistered`
- WorkflowTemplate: `WorkflowTemplateCreated`, `WorkflowTemplateUpdated`, `WorkflowTemplateDeleted`
- Workflow: `WorkflowCreated`, `WorkflowStarted`, `WorkflowPaused`, `WorkflowResumed`, `WorkflowCompleted`, `WorkflowFailed`, `WorkflowCancelled`, `WorkflowGitRefsUpdated`, `WorkflowMcpServerRefsUpdated`
- Work: `WorkStatusChanged`, `WorkStarted`, `WorkCompleted`
- Agent: `AgentStarted`, `AgentStopped`, `AgentError`
- Task/Query: `TaskStarted`, `TaskCompleted`, `QuerySent`, `QueryResponded`, `QueryFailed`
- Report: `ReportGenerationStarted`, `ReportGenerated`, `ReportFailed`
- Checkpoint: `CheckpointCreated`
- Resource: `WorkTreeCreated`, `WorkTreeFailed`, `WorkTreePendingRelease`, `WorkTreeReleased`, `WorkSpaceCreated`

**테스트**
- 각 이벤트 생성 시 필수 페이로드 검증
- 이벤트 `type` 문자열이 유일한지 검증

---

## Phase 3: Aggregate 구현

비즈니스 로직의 핵심. 상태 전이, 불변식 보호, 이벤트 발행을 포함한다. **의존성이 가장 적은 Aggregate부터** 구현한다.

**작업 순서**

3-1. **AggregateRoot 기반 클래스**
- `version` 필드 (낙관적 잠금용)
- `domainEvents` 배열 (발행 대기 이벤트)
- `addDomainEvent()`, `clearDomainEvents()` 메서드

3-2. **Git Aggregate** (의존성: 없음)
- 필드: id, url, localPath, activeWorkflowIds
- Command: `addWorkflow(wfId)`, `removeWorkflow(wfId)`
- 불변식: activeWorkflowIds가 비어있어야 삭제 가능
- 테스트: `canDelete()` T/F, `addWorkflow` 멱등성, `removeWorkflow` 안전성

3-3. **McpServer Aggregate** (의존성: 없음, Git과 대칭)
- 필드: id, name, command, args, env, transportType, url, activeWorkflowIds
- 불변식: Git과 동일 + SSE/STREAMABLE_HTTP일 때 url 필수
- 테스트: Git과 동일 패턴 + transportType별 url 검증

3-4. **Report Aggregate** (의존성: 없음)
- 필드: id, taskId, workflowId, outline, filePath, status
- 상태 전이: PENDING → GENERATING → COMPLETED / FAILED
- 테스트: 상태 전이 규칙

3-5. **Checkpoint Aggregate** (의존성: 없음, append-only)
- 필드: id, workflowId, workId, workSequence, commitHashes, createdAt
- 불변식: commitHashes 비어있지 않음, workSequence >= 0
- 테스트: 생성 검증, 불변식 위반

3-6. **WorkTree Aggregate** (의존성: 없음)
- 필드: id, gitId, workflowId, path, branch, status
- 상태 전이: PENDING → CREATING → READY / FAILED, READY → PENDING_RELEASE → RELEASED
- 테스트: 모든 상태 전이 조합

3-7. **Work Aggregate + Task 내부 엔티티** (의존성: 없음)
- Work 필드: id, workflowId, sequence, model, gitRefs, mcpServerRefs, agentStatus, tasks, currentTaskIndex
- Task 필드: id, order, query, reportId, queryStatus, reportStatus
- `computedStatus()` 파생 상태
- Command: `advanceToNextTask()`, `currentTask()`, `startAgent()`, `pause()`, `cancel()`, `reset()`
- 테스트: Task 진행, 파생 상태 계산, 불변식 (tasks 최소 1개 등)

3-8. **WorkflowSpace Aggregate + WorkSpace 내부 엔티티** (의존성: 없음)
- WorkflowSpace 필드: id, workflowId, path, workSpaces, status
- WorkSpace 필드: id, workId, path, links, status
- SymLink 값 객체: type, targetId, targetPath, linkPath
- 테스트: 상태 전이, WorkSpace 추가/제거, SymLink 관리

3-9. **WorkflowTemplate Aggregate** (의존성: 없음)
- 필드: id, name, description, workDefinitions, gitRefs, mcpServerRefs
- WorkDefinition / TaskDefinition 값 객체
- Command: `updateGitRefs`, `updateMcpServerRefs`, `removeGitRef`, `removeMcpServerRef`, `addWorkDefinition`, `removeWorkDefinition`, `updateWorkDefinition`
- 테스트: 캐스케이딩 제거 (removeGitRef, removeMcpServerRef), 불변식 (workDefinitions 비어있지 않음)

3-10. **Workflow Aggregate** (의존성: 없음, 가장 복잡한 상태 머신)
- 필드: id, issueKey, branchStrategy, gitRefs, mcpServerRefs, workIds, workSequences, workTreeStatuses, workStatuses, status
- `computedStatus()` 파생 상태
- Command: `start()`, `pause()`, `resume()`, `cancel()`, `addWork()`, `updateWorkStatuses()`, `updateWorkTreeStatuses()`
- 불변식: 각 상태에서 허용되는 전이만 가능, gitRefs 최소 1개
- 테스트: **모든 상태 전이 조합** (CREATED→PREPARING→READY→RUNNING→COMPLETED 등), `canStart()`, `canPause()`, `canResume()`, `canCancel()`, `canDelete()`, `canModify()` 각각 모든 상태에서 테스트

---

## Phase 4: Port 인터페이스 정의

Domain Layer가 의존하는 외부 인터페이스를 선언한다. 구현체는 아직 만들지 않는다.

**작업 내용**

4-1. **Repository Port**
- `GitRepository`, `McpServerRepository`, `WorkflowTemplateRepository`
- `WorkflowRepository`, `WorkRepository`, `ReportRepository`
- `CheckpointRepository`, `WorkTreeRepository`, `WorkflowSpaceRepository`
- 각 Repository에 필요한 조회 메서드 (findById, findByWorkflowId 등)

4-2. **Infrastructure Port**
- `GitClient` (clone, createWorktree, deleteWorktree, createBranch, deleteBranch, commit, reset, resetToBranch, hasChanges, getCurrentCommit, deleteRepo)
- `AgentClient` (start, stop, sendQuery)
- `McpClient` (validate, listTools)
- `FileSystem` (createDirectory, deleteDirectory, deleteFile, createSymlink, deleteSymlink, exists)
- `EventPublisher` (publish)

**테스트**: 이 단계에서는 인터페이스 정의만 하므로 별도 테스트 없음

---

## Phase 5: Domain Service 구현

Aggregate 간 조율이 필요한 도메인 로직을 서비스로 구현한다. Port 인터페이스에 의존하되, 구현체는 주입받는다.

**작업 내용**

5-1. **GitLifecycleService**
- `registerUsage(workflowId, gitIds)` — Git.addWorkflow
- `releaseUsage(workflowId, gitIds)` — Git.removeWorkflow (idempotent)
- 의존: GitRepository

5-2. **McpLifecycleService**
- `registerUsage(workflowId, mcpServerIds)` — McpServer.addWorkflow
- `releaseUsage(workflowId, mcpServerIds)` — McpServer.removeWorkflow (idempotent)
- `validate(mcpServerId)`, `listTools(mcpServerId)`
- 의존: McpServerRepository, McpClient

5-3. **WorkflowResourceService**
- `prepareResources(workflowId)` — WorkflowSpace 생성, WorkTree 일괄 생성
- `cleanupResources(workflowId)` — WorkTree/Branch/WorkflowSpace 일괄 삭제
- `prepareWorkSpace(workId)` — WorkSpace + symlink 구성
- `cleanupFromSequence(workflowId, fromSequence)` — Resume 시 정리
- `createSingleWorkTree(...)`, `deleteSingleWorkTree(...)`, `scheduleWorkTreeRelease(...)`, `releasePendingWorkTrees(...)`
- 의존: 다수 Repository + FileSystem + GitClient + EventPublisher

5-4. **CheckpointService**
- `createCheckpoint(workflowId, workId)` — 각 WorkTree의 현재 커밋 해시 스냅샷
- `rollback(checkpoint)` — git reset으로 복원
- `findValidCheckpoints(workflowId)` — workSequence 기준 유효 Checkpoint 필터링
- 의존: CheckpointRepository, WorkflowRepository, WorkTreeRepository, GitClient

**테스트**: Port를 In-Memory/Mock으로 대체하여 테스트
- GitLifecycleService: 등록/해제 정상 동작, 해제 멱등성
- WorkflowResourceService: 리소스 생성 성공, 부분 실패 시 롤백
- CheckpointService: Checkpoint 생성, rollback, 유효성 판정

---

## Phase 6: 테스트 인프라 구축

Integration Test와 E2E Test에서 사용할 In-Memory Repository, Fake Client, Test Fixture를 구현한다.

**작업 내용**

6-1. **In-Memory Repository** (9개)
- `InMemoryGitRepository`, `InMemoryMcpServerRepository`, `InMemoryWorkflowTemplateRepository`
- `InMemoryWorkflowRepository`, `InMemoryWorkRepository`, `InMemoryReportRepository`
- `InMemoryCheckpointRepository`, `InMemoryWorkTreeRepository`, `InMemoryWorkflowSpaceRepository`
- 각 Repository의 특수 조회 메서드 구현 (findByGitId, findByWorkflowIdAndGitId 등)

6-2. **Fake Infrastructure Client**
- `FakeGitClient` — clone/worktree/branch/commit을 메모리 내 시뮬레이션
- `FakeAgentClient` — start 시 AgentStarted 이벤트 자동 발행, sendQuery에 configurable 응답
- `FakeMcpClient` — validate 항상 성공 (에러 시나리오 설정 가능)
- `FakeFileSystem` — 메모리 내 디렉토리/파일/symlink 트리

6-3. **EventSpy** — 발행된 이벤트 캡처 및 검증

6-4. **Test Builder** (Builder 패턴)
- `WorkflowBuilder`, `WorkBuilder`, `TaskBuilder`, `GitBuilder`, `McpServerBuilder`
- `CheckpointBuilder`, `WorkflowTemplateBuilder`, `ReportBuilder`
- 기본값 제공, 필요한 필드만 오버라이드

6-5. **Contract Test Suite**
- Repository 공유 테스트 스위트: save → findById 왕복, delete 후 null 등
- In-Memory Repository에 적용하여 검증

**테스트**
- 각 In-Memory Repository에 대해 Contract Test 실행
- Fake Client의 기본 동작 검증

---

## Phase 7: UseCase 구현 — CRUD 계열

외부 시스템 연동이 단순하거나 없는 UseCase부터 구현한다.

**작업 순서**

7-1. **Git UseCase**
- `CreateGitUseCase` — GitClient.clone → Git.create → 저장 → 이벤트
- `DeleteGitUseCase` — 삭제 가능 확인 → GitClient.deleteRepo → 삭제 → Template 캐스케이딩 → 이벤트
- 테스트: 정상 생성/삭제, 사용 중 삭제 시도 거부, 캐스케이딩 제거

7-2. **McpServer UseCase**
- `RegisterMcpServerUseCase` — McpClient.validate → 생성 → 저장 → 이벤트
- `UnregisterMcpServerUseCase` — 삭제 가능 확인 → 삭제 → Template 캐스케이딩 → 이벤트
- 테스트: 정상 등록/삭제, 연결 검증 실패, 사용 중 삭제 거부, 캐스케이딩

7-3. **WorkflowTemplate UseCase**
- `CreateWorkflowTemplateUseCase` — gitId/mcpServerId 존재 검증 → 생성 → 저장
- `CreateTemplateFromWorkflowUseCase` — Workflow에서 구조 추출 → Template 생성
- `UpdateWorkflowTemplateUseCase` — 부분 업데이트
- `DeleteWorkflowTemplateUseCase` — 삭제 (제약 없음)
- 테스트: 정상 CRUD, 참조 무결성 검증 실패, Workflow → Template 역생성

7-4. **CreateWorkflowUseCase**
- Template 깊은 복사 → Workflow + Work + Task + Report 일괄 생성
- 테스트: Template 구조가 Workflow로 정확히 복사되는지, Report 생성, 상태 CREATED

---

## Phase 8: UseCase 구현 — Workflow 생명주기

복잡한 Saga 패턴과 보상 트랜잭션이 필요한 UseCase를 구현한다.

**작업 순서**

8-1. **StartWorkflowUseCase** (Saga 패턴)
- Step 1: Git 사용 등록 (비관적 잠금)
- Step 2: McpServer 사용 등록 (비관적 잠금)
- Step 3: 리소스 생성 (WorkflowSpace, WorkTree)
- Step 4: Workflow 상태 → RUNNING
- Step 5: WorkflowStarted 이벤트 발행
- 보상 트랜잭션: 각 단계 실패 시 역순 롤백
- 테스트: 정상 시작, 각 Step별 실패 시 보상 트랜잭션 검증, 상태 복원 확인

8-2. **PauseWorkflowUseCase**
- 실행 중 Work 조회 → Agent 중지 → Work/Workflow 상태 변경
- 테스트: 정상 일시정지, RUNNING이 아닌 상태에서 시도 거부

8-3. **ResumeWorkflowUseCase**
- Auto/FromCheckpoint 전략 분기
- Checkpoint rollback (git reset)
- WorkSpace/Report 정리 → Work reset → Workflow RESUMING
- 테스트: Auto resume (Checkpoint 있음/없음), FromCheckpoint resume, rollback 실패 처리

8-4. **CancelWorkflowUseCase**
- Agent 중지 → Work/Task 취소 → Workflow 취소
- 테스트: 정상 취소, 미완료 Task CANCELLED 처리

8-5. **DeleteWorkflowUseCase** (Saga 패턴)
- 리소스 정리 (best-effort) → Git/MCP 사용 해제 → 하위 엔티티 삭제 → Workflow 삭제
- 테스트: 정상 삭제, 리소스 정리 부분 실패 시 계속 진행

8-6. **StartNextWorkUseCase**
- PENDING Work 조회 → GitRef/McpServerRef 병합 → WorkSpace 준비 → Agent 시작
- 모든 Work 완료 시 WorkflowCompleted 발행
- 테스트: 다음 Work 시작, 모든 Work 완료 시 Workflow 완료, 설정 병합 검증

8-7. **SendQueryUseCase / CompleteTaskUseCase**
- SendQuery: currentTask 조회 → Agent에 Query 전송
- CompleteTask: advanceToNextTask → 이벤트 체인
- 테스트: Task 진행, 마지막 Task 완료 시 WorkCompleted

8-8. **ModifyWorkflowUseCase** (6개 sub-operation)
- AddTask, RemoveTask, UpdateTask, ReorderTasks
- UpdateGitRefs (WorkTree 캐스케이딩 생성/삭제)
- UpdateMcpServerRefs
- 테스트: 각 operation 정상 동작, RUNNING 상태에서 거부, GitRef 변경 시 WorkTree 캐스케이딩

8-9. **ReorderWorksUseCase**
- Work 순서 변경 → Checkpoint 자동 무효화
- 테스트: 순서 변경, 기존 Checkpoint 무효화 확인

---

## Phase 9: Event Handler 구현

이벤트 체인을 통한 비동기 실행 흐름을 구현한다.

**작업 내용**

9-1. **Work 이벤트 핸들러**
- `WorkStatusChangedHandler` → Workflow.workStatuses 업데이트
- `WorkStartedHandler` → SendQueryUseCase 트리거 (첫 Task)
- `WorkCompletedHandler` → Checkpoint 생성 → StartNextWorkUseCase (동기 순차)

9-2. **Resource 이벤트 핸들러**
- `WorkTreeStatusChangedHandler` → Workflow.workTreeStatuses 업데이트 (READY/FAILED)

9-3. **Workflow 종료 핸들러**
- `WorkflowTerminatedHandler` (WorkflowCompleted/Cancelled/Failed) → Git/MCP 사용 해제, PENDING_RELEASE WorkTree 삭제

9-4. **Agent 이벤트 핸들러**
- `AgentStartedHandler` → Work.agentStatus RUNNING
- `AgentStoppedHandler` → Work.agentStatus STOPPED
- `AgentErrorHandler` → Work.agentStatus ERROR → WorkflowFailed

9-5. **Query/Report 이벤트 핸들러**
- `QueryRespondedHandler` → Report 있으면 생성 시작, 없으면 CompleteTask
- `QueryFailedHandler` → queryStatus FAILED
- `ReportGeneratedHandler` → Report 완료 → CompleteTask → 다음 Task SendQuery
- `ReportFailedHandler` → reportStatus FAILED

9-6. **캐스케이딩 핸들러**
- `GitDeletedHandler` → 모든 Template에서 gitRef 제거
- `McpServerUnregisteredHandler` → 모든 Template에서 mcpServerRef 제거

**테스트** (Integration Test)
- 전체 이벤트 체인 시나리오: WorkflowStarted → ... → WorkflowCompleted
- Resume 흐름: WorkflowFailed → ResumeWorkflow → 재실행
- 에러 전파: AgentError → WorkflowFailed
- Checkpoint 생성 → StartNextWork 순서 보장
- 멱등성: 동일 이벤트 중복 처리 시 부작용 없음

---

## Phase 10: 에러 처리 & 복원력

**작업 내용**

10-1. **에러 클래스 계층**
- `DomainError` (base), `InvalidStateTransitionError`, `InvariantViolationError`
- `GitCloneError`, `AgentStartError`, `McpValidationError` 등 (isTransient 플래그)

10-2. **Retry 유틸리티**
- Exponential backoff with jitter
- 외부 의존성별 retry 설정 적용 (GitClient, AgentClient, McpClient, FileSystem)
- `sendQuery`는 retry 불가 (비멱등)

10-3. **Circuit Breaker**
- GitClient (전역), McpClient (서버별) Circuit Breaker
- Closed → Open → Half-Open 상태 머신

10-4. **낙관적 잠금**
- `withOptimisticRetry<T>` 유틸리티
- 모든 Aggregate의 version 기반 충돌 감지

**테스트**
- Retry: transient 에러 시 재시도 성공, permanent 에러 시 즉시 실패
- Circuit Breaker: 상태 전이, 연속 실패 시 Open, probe 성공 시 Closed
- 낙관적 잠금: 동시 수정 시 OptimisticLockException, 재시도 성공

---

## Phase 11: Infrastructure Adapter 구현

실제 외부 시스템과 연동하는 구현체를 만든다.

**작업 내용**

11-1. **Repository Adapter** (Prisma 또는 Drizzle ORM)
- 9개 Repository의 DB 구현체
- Outbox 테이블 및 Relay 구현 (Polling 방식)
- DB 마이그레이션 스크립트

11-2. **GitClient Adapter**
- `execa` 또는 `child_process.execFile`로 git CLI 래핑
- clone, worktree add/remove, branch, commit, reset 구현

11-3. **AgentClient Adapter**
- `child_process.spawn`으로 Agent CLI 실행
- stdout/stderr 파싱으로 Agent 이벤트 수신
- MCP config 파일 생성 및 주입

11-4. **McpClient Adapter**
- STDIO: spawn → initialize handshake → tools/list
- SSE/HTTP: HTTP 클라이언트로 연결

11-5. **FileSystem Adapter**
- `fs.promises` 기반 구현
- 경로 보안 검증 (`PathSecurityService`) 통합

11-6. **EventPublisher Adapter**
- 개발: In-Memory EventEmitter
- 프로덕션: Redis Pub/Sub 또는 BullMQ

**테스트**
- Contract Test Suite를 DB Repository에 적용
- GitClient: 실제 git 명령 실행 (로컬 테스트 리포지토리)
- FileSystem: 실제 파일시스템 작업 검증
- Outbox Relay: 이벤트 발행 → Outbox 저장 → Relay → Handler 전달 검증

---

## Phase 12: Presentation Layer — REST API

**작업 내용**

12-1. **HTTP 프레임워크 설정** (Express, Fastify, 또는 NestJS)
- 공통 미들웨어: 에러 핸들러, 요청 로깅, correlationId 생성

12-2. **Request Validation** (zod 또는 class-validator)
- 각 엔드포인트별 DTO 스키마 정의
- Presentation 계층 형식 검증

12-3. **REST Controller 구현**
- Git: POST/GET/DELETE `/api/gits`
- McpServer: POST/GET/DELETE `/api/mcp-servers`
- WorkflowTemplate: POST/GET/PUT/DELETE `/api/workflow-templates`, POST `.../from-workflow`
- Workflow: POST/GET/DELETE `/api/workflows`, POST `.../start|pause|resume|cancel`, PATCH (Modify)

12-4. **Response DTO & Serialization**
- 공통 Envelope (`ApiResponse<T>`, `PaginatedResponse<T>`, `ErrorResponse`)
- Cursor-based Pagination 구현
- McpServer.env 마스킹, GitUrl 토큰 마스킹

12-5. **에러 코드 매핑**
- DomainError → HTTP 상태코드 + 에러 코드 (GIT_001, WFL_002 등)

**테스트** (E2E)
- 각 엔드포인트: 정상 요청 → 기대 응답 코드/바디
- 유효하지 않은 요청 → 400 Bad Request
- 존재하지 않는 리소스 → 404 Not Found
- 상태 충돌 → 409 Conflict
- Pagination: cursor 전달, 다음 페이지 조회

---

## Phase 13: Presentation Layer — WebSocket

**작업 내용**

13-1. **WebSocket 서버 설정**
- 연결 관리, 인증 (Bearer Token)

13-2. **구독/해제 메시지 처리**
- `subscribe(workflowId)`, `unsubscribe(workflowId)`, `subscribeGlobal`
- Workflow별 이벤트 라우팅

13-3. **이벤트 → WebSocket 메시지 변환**
- DomainEvent → EventMessage 매핑
- sequenceNumber 부여
- 재연결 시 lastSequenceNumber 기반 재전송

13-4. **Heartbeat**
- ping/pong (30초 주기), idle timeout (60초)

**테스트**
- WebSocket 연결/구독/해제 플로우
- 이벤트 발생 시 구독 클라이언트에 전달 확인
- 재연결 후 누락 이벤트 재수신

---

## Phase 14: 인증 & 보안

**작업 내용**

14-1. **JWT 인증**
- Token 발급 (login), 검증, 갱신 (refresh)
- RS256 서명, jti 기반 Revocation

14-2. **API Key 인증**
- 발급, 해시 저장 (SHA-256), 검증
- 최소 권한 principle

14-3. **인가 미들웨어 (RBAC)**
- Admin / Operator / Viewer 역할
- UseCase별 접근 매트릭스 적용

14-4. **데이터 보호**
- McpServer.env 암호화 (AES-256-GCM)
- GitUrl 토큰 마스킹 (로그, API 응답)
- 경로 보안 (PathSecurityService)

14-5. **API 보안**
- Rate Limiting (Token Bucket)
- CORS 정책
- HTTPS 강제, 보안 헤더 (helmet)
- Request 크기 제한

14-6. **Prompt Injection 방어**
- QuerySanitizer (위험 패턴 탐지)
- System Prompt 래핑 (Agent 행동 범위 제한)

**테스트**
- JWT: 유효/만료/위조 토큰 검증
- RBAC: 역할별 접근 허용/거부
- Rate Limiting: 제한 초과 시 429
- 경로 보안: path traversal 차단
- Prompt sanitization: 위험 패턴 탐지

---

## Phase 15: 운영 & 모니터링

**작업 내용**

15-1. **구조화 로깅**
- JSON structured logging
- correlationId 전파
- 민감 정보 마스킹

15-2. **헬스 체크**
- `GET /health` (liveness)
- `GET /ready` (readiness — DB, Git, MCP, EventBus, FileSystem)

15-3. **메트릭**
- Prometheus `/metrics` 엔드포인트
- Workflow, Agent, Resource, System 메트릭

15-4. **분산 트레이싱** (OpenTelemetry)
- Span 계층 구조, Attribute 표준

15-5. **감사 로그**
- AuditLogger: 상태 변경/보안 이벤트 기록

15-6. **리소스 정리 스케줄러**
- WorkTree 자동 정리 (TTL 기반)
- Report 아카이브/삭제
- 무효 Checkpoint 정리
- 디스크 용량 모니터링

15-7. **Graceful Shutdown**
- SIGTERM → 요청 중단 → Workflow Pause → 이벤트 drain → 종료

15-8. **Docker 컨테이너화**
- Multi-stage Dockerfile
- 환경변수 관리

**테스트**
- Health check: 의존성 정상/비정상 시 응답 코드
- Graceful shutdown: SIGTERM 후 실행 중 Workflow가 PAUSED로 전이

---

## Phase 간 의존 관계

```
Phase 0 (스캐폴딩)
  └→ Phase 1 (Value Object & Enum)
      └→ Phase 2 (Domain Event)
          └→ Phase 3 (Aggregate)
              ├→ Phase 4 (Port 인터페이스)
              │   └→ Phase 5 (Domain Service)
              │       └→ Phase 6 (테스트 인프라)
              │           ├→ Phase 7 (UseCase — CRUD)
              │           │   └→ Phase 8 (UseCase — 생명주기)
              │           │       └→ Phase 9 (Event Handler)
              │           │           └→ Phase 10 (에러 처리)
              │           └→ Phase 11 (Infrastructure Adapter)
              │               └→ Phase 12 (REST API)
              │                   └→ Phase 13 (WebSocket)
              │                       └→ Phase 14 (인증 & 보안)
              │                           └→ Phase 15 (운영 & 모니터링)
              └→ (Phase 4와 병렬 가능)
```

---

## 관련 문서
- [01-서비스-개요.md](01-서비스-개요.md) — 전체 아키텍처
- [02-도메인-모델.md](02-도메인-모델.md) — Aggregate, Value Object 상세
- [03-유스케이스.md](03-유스케이스.md) — UseCase 상세
- [04-이벤트-흐름.md](04-이벤트-흐름.md) — 이벤트 기반 실행 흐름
- [05-인프라스트럭처.md](05-인프라스트럭처.md) — Port/Adapter 및 리소스 관리
- [06-API-설계.md](06-API-설계.md) — REST API 및 WebSocket
- [07-에러처리-및-복원력.md](07-에러처리-및-복원력.md) — 에러 분류, 재시도, Circuit Breaker
- [08-동시성-및-트랜잭션.md](08-동시성-및-트랜잭션.md) — 동시성 제어, Saga
- [09-인증-및-보안.md](09-인증-및-보안.md) — 인증, 인가, 데이터 보호
- [10-운영-및-모니터링.md](10-운영-및-모니터링.md) — 로깅, 메트릭, 배포
- [11-검증-및-테스트.md](11-검증-및-테스트.md) — 검증 규칙, 테스트 전략
