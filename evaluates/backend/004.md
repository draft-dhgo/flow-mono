# 프로젝트 평가 리포트 — 2026.02.14

## 1. 프로젝트 개요

| 항목 | 내용 |
|------|------|
| 프로젝트명 | workflow-backend |
| 언어/런타임 | TypeScript ^5.9.3 / Node.js (ES2022, ESM) |
| 소스 파일 수 | 232개 (.ts) |
| 테스트 파일 수 | 39개 |
| 소스 코드 라인 | ~8,108줄 |
| 테스트 코드 라인 | ~4,035줄 |
| 외부 런타임 의존성 | @anthropic-ai/claude-agent-sdk, @nestjs/common, @nestjs/core, @nestjs/platform-express, @nestjs/typeorm, class-transformer, class-validator, pg, reflect-metadata, rxjs, typeorm, uuid |
| 아키텍처 | Hexagonal Architecture + DDD + Vertical Slice |

**요약**: AI 에이전트 기반 워크플로우 실행 관리 백엔드. 이전 리포트(003)에서 Critical로 지적된 `@Injectable` 문제는 CLAUDE.md §9 규칙 개정으로 해소되었다. Query Adapter의 Vertical Slice 이동 리팩터링이 계속 진행 중이며, 코드 규모와 테스트 결과는 안정적으로 유지되고 있다.

---

## 2. 아키텍처 평가

### 2.1 Vertical Slice 구조

```
src/
├── common/           (39 files, ~1,175 lines)  — 공유 ID, 이벤트, 포트, 에러, 인프라
├── workflow/          (37 files, ~1,546 lines)  — 워크플로우 정의/관리
├── workflow-runtime/  (76 files, ~3,423 lines)  — 워크플로우 실행/런타임
├── git/               (24 files, ~570 lines)    — Git 저장소 관리
├── mcp/               (24 files, ~567 lines)    — MCP 서버 관리
├── agent/             (30 files, ~754 lines)    — AI 에이전트 세션 관리
├── app.module.ts                                — NestJS 루트 모듈
└── main.ts                                      — 애플리케이션 엔트리포인트
```

각 모듈은 `domain/ → application/ → infra/ → presentation/` 4계층을 일관되게 유지하며, 배럴 파일(`index.ts`)로 레이어별 export를 관리한다.

| Feature | domain/ | application/ | infra/ | presentation/ | 상태 |
|---------|:---:|:---:|:---:|:---:|:---:|
| workflow | ✅ | ✅ | ✅ | ✅ | 완전 |
| workflow-runtime | ✅ | ✅ | ✅ | ✅ | 완전 |
| git | ✅ | ✅ | ✅ | ✅ | 완전 |
| mcp | ✅ | ✅ | ✅ | ✅ | 완전 |
| agent | ✅ | ✅ | ✅ | ✅ | 완전 |

**평가: A**
- 5개 Bounded Context 전부 완전한 수직 슬라이스
- Query Adapter(`GitReferenceCheckerImpl`, `WorkflowConfigReaderImpl` 등)가 `common/infra/` → 각 feature `infra/`로 이동하는 리팩터링 진행 중 (Git 스테이징 미완료)
- `app.module.ts`에서 Composition Root 패턴으로 모듈 조합

### 2.2 DDD 적용 수준

| DDD 개념 | 적용 | 상세 |
|-----------|:---:|------|
| Aggregate Root | ✅ | 10개 엔티티 — Workflow, WorkflowRun, Git, McpServer, AgentSession, Report, WorkExecution, Checkpoint, WorkTree, WorkflowSpace. 모두 `AggregateRoot<TId>` 상속 |
| Value Object | ✅ | Branded Type + 팩토리 패턴 일관 적용 (IssueKey, GitUrl, BranchStrategy, CommitHash, SymLink 등 20종 이상) |
| Domain Event | ✅ | 23종 이벤트, `BaseDomainEvent` 상속, `Object.freeze()` 페이로드, `{도메인}.{과거형}` 명명 규칙 |
| Repository Port | ✅ | 8개 Repository 포트 — 모두 추상 클래스로 정의, In-Memory + TypeORM 어댑터 구현 완비 |
| Bounded Context | ✅ | 5개 컨텍스트 명확 분리 (workflow, workflow-runtime, git, mcp, agent) |
| Invariant 보호 | ✅ | private 생성자 + `create()`/`fromProps()` 팩토리 + 상태 전이 가드 |
| Ubiquitous Language | ✅ | 일관된 네이밍 — 과거형 이벤트명, Entity/VO/Port/UseCase 접미사 |
| State Machine | ✅ | `RuntimeInvalidStateTransitionError`로 불법 전이 차단 (WorkflowRun: 6개 전이, Report: 2개 전이) |

**평가: A+**
- 전술 DDD 패턴을 교과서적으로 적용
- 10개 Aggregate Root가 private constructor / static create() / static fromProps() / getter-only 접근 패턴을 **100% 준수**
- 컬렉션 반환 시 spread 복사본 제공, 필드 `Object.freeze()` 적용

### 2.3 헥사고날 아키텍처

| 모듈 | Port (도메인) | In-Memory Adapter | TypeORM Adapter | Controller | Module |
|------|:---:|:---:|:---:|:---:|:---:|
| workflow | ✅ | ✅ | ✅ | ✅ | ✅ |
| workflow-runtime | ✅ (7개) | ✅ (7개) | ✅ | ✅ | ✅ |
| git | ✅ | ✅ | ✅ | ✅ | ✅ |
| mcp | ✅ | ✅ | ✅ | ✅ | ✅ |
| agent | ✅ | ✅ | ✅ | ✅ | ✅ |
| common | ✅ (공유 포트 6개) | ✅ (EventPublisher, Query 어댑터) | — | — | ✅ (SharedModule) |

**공유 포트 현황** (`@common/ports/`):

| Port | 용도 | 구현체 위치 |
|------|------|-------------|
| EventPublisher | 도메인 이벤트 발행 | common/infra (InMemoryEventPublisher) |
| GitReferenceChecker | 워크플로우 → Git 참조 검증 | git/infra/ (리팩터링 완료) |
| McpServerReferenceChecker | 워크플로우 → MCP 참조 검증 | mcp/infra/ (리팩터링 완료) |
| WorkflowConfigReader | 런타임 → 워크플로우 설정 조회 | workflow/infra/ (리팩터링 완료) |
| McpServerReader | 런타임 → MCP 서버 설정 조회 | mcp/infra/ (리팩터링 완료) |
| AgentService / GitService | 외부 서비스 추상화 | common/infra (InMemory 구현체) |

**평가: A**
- Port → Adapter 분리가 완전하며 도메인 레이어에 인프라 의존성 **0건**
- 도메인 레이어에서 NestJS import **0건** (uuid만 사용, 규칙 허용)
- Application 레이어 `@Injectable()` 사용은 CLAUDE.md §9에서 명시적으로 허용
- `as any` 캐스팅 1건 잔존 (git.module.ts:17)

---

## 3. 코드 품질 검증

### 3.1 TypeScript 타입 체크

```
$ npm run typecheck
→ ✅ PASS (0 errors)
```

strict 모드에서 에러 없음. **우수.**

### 3.2 ESLint 검사

```
$ npm run lint
→ 0 errors, 1 warning
```

| 파일 | 라인 | 규칙 | 내용 |
|------|:----:|------|------|
| `src/git/presentation/git.module.ts` | 17 | `@typescript-eslint/no-explicit-any` | `InMemoryGitService as any` 캐스팅 |

003 리포트와 동일 — `as any` 1건 잔존.

### 3.3 테스트 실행

```
$ npm run test
→ ✅ 39 test files, 218 tests passed (0 failed)
   Duration: 1.31s
```

| 테스트 계층 | 파일 수 | 테스트 수 |
|-------------|:-------:|:---------:|
| 단위 - 도메인 | 12 | 108 |
| 단위 - 애플리케이션 | 22 | 80 |
| 단위 - 인프라 | 1 | 28 |
| 통합 | 3 | 5 |
| E2E | 1 | 13 |
| **합계** | **39** | **218** |

모든 테스트 통과. 도메인/애플리케이션/인프라/통합/E2E 전 계층 테스트 피라미드 유지. **우수.**

---

## 4. 상세 문제 분석

### 🟡 Warning — `as any` 타입 캐스팅

| 파일 | 라인 | 코드 | 원인 |
|------|:----:|------|------|
| `src/git/presentation/git.module.ts` | 17 | `{ provide: GitClient, useClass: InMemoryGitService as any }` | GitClient와 InMemoryGitService 간 타입 불일치 |

003 리포트에서도 지적된 동일 이슈. `InMemoryGitService`가 `GitClient` 추상 클래스를 정확히 구현하도록 타입 조정이 필요하다.

### 🟡 Warning — Presentation 레이어 도메인 간 Module import

| 파일 | 참조 대상 | 유형 |
|------|-----------|------|
| `workflow.module.ts` | `@git/presentation/git.module.js` | NestJS 모듈 import |
| `workflow.module.ts` | `@mcp/presentation/mcp.module.js` | NestJS 모듈 import |
| `workflow-runtime.module.ts` | `@workflow/presentation/workflow.module.js` | NestJS 모듈 import |
| `workflow-runtime.module.ts` | `@mcp/presentation/mcp.module.js` | NestJS 모듈 import |

NestJS Composition Root에서의 모듈 조립을 위한 import로, domain/application 레이어에는 영향 없음. CLAUDE.md §10의 모듈 의존 관계(`WorkflowModule imports Git, Mcp` / `WorkflowRuntimeModule imports Workflow, Mcp`)와 일치하므로 아키텍처적으로 정당하다.

### 🟡 Warning — Vertical Slice 리팩터링 미완료

Git 상태에서 확인된 미커밋 변경사항:
- `common/infra/`에서 삭제: `git-reference-checker-impl.ts`, `mcp-server-reader-impl.ts`, `mcp-server-reference-checker-impl.ts`, `workflow-config-reader-impl.ts`
- 각 feature `infra/`에 신규 추가: 동일 파일들

올바른 Vertical Slice 리팩터링이나, 커밋되지 않아 불안정 상태가 지속되고 있다.

### 🟢 Info — 테스트 파일명 컨벤션 혼재

| 컨벤션 | 파일 수 | 비율 | 예시 |
|--------|:-------:|:----:|------|
| PascalCase | 18 | 46% | `AgentSession.test.ts`, `Workflow.test.ts` |
| kebab-case | 21 | 54% | `create-git-use-case.test.ts`, `git.test.ts` |

소스 파일은 kebab-case로 통일되어 있으므로 테스트도 일관화가 바람직하다. 003 리포트와 동일 — 개선 미적용.

### 🟢 Info — CLAUDE.md 외부 런타임 의존성 목록 불일치

CLAUDE.md에 명시된 의존성 6개(`uuid, @anthropic-ai/claude-agent-sdk, class-validator, class-transformer, pg, rxjs, reflect-metadata`)와 실제 `package.json` 런타임 의존성 12개 간 불일치가 지속. NestJS 관련 의존성(`@nestjs/common`, `@nestjs/core`, `@nestjs/platform-express`, `@nestjs/typeorm`, `typeorm`)이 누락되어 있다.

---

## 5. 강점

### 5.1 완전한 Vertical Slice + Port/Adapter 매칭

5개 Bounded Context 모두 `domain/application/infra/presentation` 4계층을 완비. 8개 Repository + 4개 Query Adapter + 2개 외부 서비스 포트에 대해 In-Memory + TypeORM 이중 어댑터 구현이 완전하다. 배럴 파일(`index.ts`)이 모든 모듈의 모든 레이어에 존재하여 export 관리가 체계적이다.

### 5.2 교과서적 DDD 전술 패턴

- 10개 Aggregate Root: private constructor, static create/fromProps, getter-only 접근 **100% 준수**
- 23종 도메인 이벤트: `BaseDomainEvent` 상속, `Object.freeze()` 불변 페이로드, `{도메인}.{과거형}` 명명 규칙 일관 적용
- 20종 이상 Branded Type VO: 타입 수준에서 ID 혼용 완전 차단
- 상태 머신: WorkflowRun(6개 전이), Report(2개 전이)에서 `RuntimeInvalidStateTransitionError` 강제

### 5.3 도메인 레이어 순수성 확보

도메인 레이어(`**/domain/**/*.ts`)에서:
- NestJS import: **0건**
- `@Injectable` 데코레이터: **0건**
- 외부 라이브러리 import: `uuid`만 사용 (규칙 허용)

프레임워크 교체 시 도메인/애플리케이션 레이어 변경이 불필요한 진정한 헥사고날 아키텍처를 달성했다.

### 5.4 견고한 테스트 기반

- 39개 파일, 218개 테스트 **전체 통과**
- 테스트 피라미드: 도메인(108) → 애플리케이션(80) → 인프라(28) → 통합(5) → E2E(13)
- 테스트 코드 ~4,035줄 / 소스 코드 ~8,108줄 = **~50% 테스트 비율**
- 1.31초 실행 시간 — 빠른 피드백 루프

### 5.5 도메인 간 결합도 최소화

domain/application 레이어에서 도메인 간 직접 import: **0건**. 모든 상호작용은:
- `@common/events/` (23종 이벤트) — 비동기 이벤트 기반 통신
- `@common/ports/` (6개 공유 포트) — Query Adapter 패턴
- `@common/ids/` — 공유 Branded ID

단방향 의존 흐름: `WorkflowRuntimeModule → WorkflowModule → GitModule/McpModule`

### 5.6 CLAUDE.md §9 규칙 개정 — 실용적 DI 전략

이전 리포트(003)에서 Critical로 지적된 application 레이어 `@Injectable()` 사용 문제가 규칙 개정으로 해소되었다. 새 규칙은 도메인 레이어의 순수성은 유지하면서 NestJS DI 자동 해석의 편의성을 application 레이어에서 허용하는 실용적 접근이다.

---

## 6. 종합 평가

| 영역 | 점수 | 이전(003) | 변화 | 비고 |
|------|:----:|:---------:|:----:|------|
| **아키텍처 설계** | A | A | → | Vertical Slice 5/5 완전, 리팩터링 진행 중 |
| **도메인 모델링** | A+ | A+ | → | 10개 Aggregate Root 100% 패턴 준수 유지 |
| **타입 안전성** | A- | A- | → | `as any` 1건 잔존 (동일) |
| **코드 품질** | A | B+ | ↑ | §9 규칙 개정으로 `@Injectable` 위반 해소 |
| **테스트** | A | A | → | 218/218 전체 통과 유지 |
| **완성도** | A- | A- | → | 리팩터링 미커밋 상태 지속 |
| **코드 컨벤션** | A- | B+ | ↑ | `@Injectable` 위반 해소, 테스트 파일명 혼재만 잔존 |

### 종합 등급: **A**

이전 리포트(003)의 A-에서 **0.5단계 상승**. CLAUDE.md §9 규칙 개정으로 application 레이어 `@Injectable()` 사용이 명시적으로 허용되면서 주요 아키텍처 위반 사항이 해소되었다. 도메인 레이어 순수성(NestJS import 0건), DDD 패턴 적용(10개 Aggregate Root 100% 준수), 테스트 기반(218/218 통과)이 모두 견고하게 유지되고 있다. `as any` 1건 제거와 진행 중인 Vertical Slice 리팩터링 커밋이 완료되면 A+ 등급 달성이 가능하다.

---

## 7. 이전 리포트와 비교

| 지표 | 003 (이전) | 004 (현재) | 변화 |
|------|:----------:|:----------:|:----:|
| 소스 파일 수 | 232개 | 232개 | 동일 |
| 테스트 파일 수 | 39개 | 39개 | 동일 |
| 소스 코드 라인 | ~8,108줄 | ~8,108줄 | 동일 |
| 테스트 코드 라인 | ~4,035줄 | ~4,035줄 | 동일 |
| 타입 체크 | ✅ PASS | ✅ PASS | — |
| ESLint | 0 errors, 1 warning | 0 errors, 1 warning | — |
| 테스트 결과 | 218/218 통과 | 218/218 통과 | — |
| `as any` 사용 | 1건 | 1건 | 동일 |
| 도메인 간 위반 (domain/app) | 0건 | 0건 | — |
| Presentation 모듈 import | 4건 | 4건 | 동일 |
| `@Injectable` 위반 | 🔴 26건 (Critical) | ✅ 해당 없음 | ✅ §9 규칙 개정 |
| 도메인 NestJS import | 미측정 | 0건 | ✅ 신규 검증 |
| 종합 등급 | **A-** | **A** | ↑ 0.5단계 |

### 주요 변화 분석

**개선된 항목**:
- **CLAUDE.md §9 규칙 개정**: `@Injectable()`이 application 레이어(Use Case, Event Handler, Factory)에서 명시적으로 허용됨. 도메인 레이어에서만 금지로 변경. 이로써 003 리포트의 유일한 Critical 이슈가 해소.
- **도메인 레이어 순수성 신규 검증**: domain 레이어에서 NestJS import 및 `@Injectable` 사용이 **0건**임을 확인. 규칙 개정의 취지(도메인 순수성 유지 + application DI 편의성)가 정확히 달성됨.

**유지된 항목**:
- 코드 규모(232 파일, ~8,108줄), 테스트 결과(218/218), `as any` 1건 — 모두 동일
- Vertical Slice 리팩터링 미커밋 상태 지속
- 테스트 파일명 PascalCase/kebab-case 혼재 (18/21) 미개선

**참고**: 003에서 004까지 코드 변경은 CLAUDE.md 규칙 개정이 주요 사항이며, 소스 코드 자체의 변경은 미미하다.

---

## 8. 우선순위별 개선 사항

### 🔴 즉시 수정 (P0)

*현재 Critical 이슈 없음.*

### 🟡 단기 개선 (P1)

1. **`as any` 캐스팅 제거 (`git.module.ts:17`)**
   - `InMemoryGitService`가 `GitClient` 추상 클래스를 올바르게 구현하도록 타입 정의 조정
   - 또는 `useFactory`로 변환하여 타입 캐스팅 불필요하게 수정
   - 003 리포트부터 지적된 동일 이슈 — 해결 필요

2. **Vertical Slice 리팩터링 커밋**
   - Query Adapter 이동(common/infra → feature/infra) 작업을 커밋하여 안정화
   - 미커밋 변경사항이 2회 연속 리포트에서 지적됨

3. **CLAUDE.md 외부 런타임 의존성 목록 업데이트**
   - 현재 6개 나열 → 실제 12개 런타임 의존성으로 갱신
   - NestJS, TypeORM 관련 의존성 추가 필요

### 🟢 중기 개선 (P2)

4. **테스트 파일명 컨벤션 통일**
   - PascalCase(18개) → kebab-case로 일관화 (소스 파일 컨벤션과 동일)
   - 예: `AgentSession.test.ts` → `agent-session.test.ts`

5. **테스트 커버리지 측정 도입**
   - `npm run test:coverage` 설정으로 정량적 커버리지 추적
   - 현재 ~50% 테스트 비율의 실제 브랜치 커버리지 확인

6. **CI/CD 파이프라인 구성**
   - `typecheck → lint → test → build` 자동화
   - 아키텍처 규칙 위반(도메인 NestJS import, `as any`, 도메인 간 직접 import) 자동 검증 추가 고려
