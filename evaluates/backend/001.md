# 프로젝트 평가 리포트 — 2026.02.13

## 1. 프로젝트 개요

| 항목 | 내용 |
|------|------|
| 프로젝트명 | workflow-backend |
| 언어/런타임 | TypeScript 5.9.3 / Node.js (ES2022) |
| 소스 파일 수 | 158개 (.ts) |
| 테스트 파일 수 | 6개 |
| 총 코드 라인 | ~4,563줄 |
| 외부 런타임 의존성 | uuid 1개만 사용 |
| 아키텍처 | Hexagonal Architecture + DDD + Vertical Slice |

**요약**: AI 에이전트 기반 워크플로우 실행을 관리하는 백엔드 도메인 모델 프로젝트. Git 저장소, MCP 서버, 에이전트 세션을 통합하여 워크플로우를 정의하고 실행하는 시스템.

---

## 2. 아키텍처 평가

### 2.1 Vertical Slice 구조 (수직 슬라이스)

```
src/
├── common/          (28 files)  — 공유 도메인 이벤트, ID, 포트
├── workflow/        (28 files)  — 워크플로우 정의
├── workflow-runtime/(56 files)  — 워크플로우 실행/런타임
├── git/             (16 files)  — Git 저장소 관리
├── mcp/             (15 files)  — MCP 서버 관리
└── agent/           (15 files)  — AI 에이전트 세션 관리
```

각 모듈은 `domain/ → application/ → infra/ → presentation/` 4계층 구조를 일관되게 따르고 있다.

**평가: A-**
- 최근 수평 슬라이스(horizontal)에서 수직 슬라이스(vertical)로 리팩터링 완료
- 각 피처가 독립적으로 배포 가능한 구조
- 모듈 간 결합은 이벤트 기반으로 깔끔하게 분리
- 단, 리팩터링이 **미완성** 상태 (테스트 경로 미갱신)

### 2.2 DDD 적용 수준

| DDD 개념 | 적용 여부 | 상세 |
|-----------|:---------:|------|
| Aggregate Root | ✅ | Workflow, WorkflowRun, Git, McpServer, AgentSession |
| Value Object | ✅ | WorkflowId, BranchStrategy, IssueKey, ReportOutline 등 |
| Domain Event | ✅ | 13종 이상의 도메인 이벤트 정의 |
| Repository Port | ✅ | 모든 Aggregate에 대해 인터페이스 정의 |
| Bounded Context | ✅ | 6개의 명확한 컨텍스트 분리 |
| Invariant 보호 | ⚠️ | 대부분 양호하나 일부 `any` 캐스팅 위반 존재 |
| Ubiquitous Language | ✅ | 일관된 네이밍 컨벤션 |

**평가: A-**
- DDD 전술 패턴을 높은 수준으로 적용
- Branded Type으로 ID 혼용 방지 (타입 안전성 우수)
- 이벤트 기반 교차 도메인 통신은 모범적

### 2.3 헥사고날 아키텍처

**평가: B+**
- Port/Adapter 분리는 명확
- 그러나 **Adapter 구현체가 전무** (infra/ 디렉터리가 비어 있음)
- Presentation 레이어도 비어 있음
- 현재는 도메인 모델만 존재하는 상태

---

## 3. 코드 품질 검증

### 3.1 TypeScript 타입 체크

```
$ npm run typecheck
→ ✅ PASS (0 errors)
```

strict 모드 활성화 상태에서 타입 에러 없음. **우수.**

### 3.2 ESLint 검사

```
$ npm run lint
→ ❌ 4 errors, 3 warnings
```

| 파일 | 문제 | 심각도 |
|------|------|--------|
| `common/ports/workflow-config-reader.ts` | 미사용 import `GitId` | error |
| `workflow-runtime/.../query-responded-handler.ts` | 미사용 import `EventPublisher` | error |
| `workflow/domain/value-objects/branch-name.ts` | 정규식에 제어 문자(\x00, \x1f) + 불필요 이스케이프 | error ×2 |
| `workflow-runtime/.../start-workflow-run-use-case.ts` | `'' as any` 캐스팅 | warning ×2 |
| `tests/.../workflow-run.test.ts` | `any` 타입 사용 | warning |

### 3.3 테스트 실행

```
$ npm run test
→ ❌ 6 failed, 0 passed
```

**전체 테스트가 실패한다.** 원인은 vertical slice 리팩터링 후 테스트의 import 경로가 갱신되지 않았기 때문이다.

```
Cannot find package '@domain/workflow-runtime/entities/...'
```

테스트는 `@domain/...` 경로를 사용하지만, 현재 tsconfig/vitest 설정은 `@workflow-runtime/...`, `@workflow/...` 등을 사용한다.

---

## 4. 상세 문제 분석

### 4.1 🔴 Critical — 테스트 전면 실패

모든 6개 테스트 파일이 import 경로 오류로 실행 불가. vertical slice 리팩터링의 가장 큰 미완성 사항.

**영향**: 도메인 로직 변경 시 회귀 방지가 불가능.

### 4.2 🔴 Critical — Report ID 할당 안티패턴

```typescript
// start-workflow-run-use-case.ts:63-64
const report = Report.create({
  taskExecutionId: '' as any,   // ← 빈 문자열을 Branded Type으로 강제 캐스팅
  workExecutionId: '' as any,   // ← DDD 불변식 위반
  workflowRunId: run.id,
  outline: runtimeOutline,
});
```

Branded Type 시스템을 우회하는 `as any` 캐스팅. DDD에서 Aggregate의 ID는 생성 시점부터 유효해야 하는데, 빈 문자열로 초기화하고 있다. 이는:
- 타입 안전성을 근본적으로 훼손
- Report가 유효하지 않은 상태로 영속화될 수 있음
- 이 패턴이 다른 곳으로 전파될 위험

### 4.3 🟡 Warning — Use Case 단일 책임 위반

`StartWorkflowRunUseCase`가 111줄에 걸쳐 다음을 모두 수행:
1. 워크플로우 설정 조회
2. WorkflowRun 생성
3. Report 생성 (outline 파싱 포함)
4. WorkExecution 생성
5. 3개 Repository에 저장
6. 이벤트 수집 및 발행

복잡한 생성 로직을 Factory 또는 Domain Service로 분리해야 한다.

### 4.4 🟡 Warning — 빈 인프라/프레젠테이션 레이어

```
src/workflow/infra/          → 비어 있음
src/workflow/presentation/   → 비어 있음
src/git/infra/               → 비어 있음
...
```

포트 인터페이스만 존재하고 구현체가 없다. 헥사고날 아키텍처의 핵심인 Adapter가 누락된 상태. 아직 개발 초기로 도메인에 집중하고 있다는 의미일 수 있으나, 디렉터리만 생성해둔 빈 뼈대가 많아 프로젝트 전체적으로 미완성 인상을 준다.

### 4.5 🟡 Warning — 정규식 보안 이슈

```typescript
// branch-name.ts:14
private static readonly INVALID_CHARS = /[\x00-\x1f\x7f ~^:?*\[\\]/;
```

`\x00`, `\x1f` 제어 문자를 정규식에 직접 포함하고 있으며, `\[`가 불필요한 이스케이프로 처리됨. 이는 ESLint `no-control-regex` 규칙 위반이다.

### 4.6 🟢 Info — 방어적 복사 오버헤드

모든 getter에서 배열/맵을 복사하는 패턴:
```typescript
get gitRefs(): ReadonlyArray<GitRef> {
  return [...this._gitRefs];
}
```

불변 객체에 대해 매번 스프레드 복사를 수행하는 것은 과잉 방어. `ReadonlyArray` 반환만으로도 외부 변경을 방지할 수 있다.

---

## 5. 강점

### 5.1 도메인 모델의 풍부함
- 상태 머신(WorkflowRun: INITIALIZED → RUNNING → PAUSED → COMPLETED/CANCELLED)이 명확하게 구현
- 체크포인트 기반 복원, 작업 시퀀스 관리 등 복잡한 비즈니스 로직이 도메인 안에 캡슐화
- 19개 이상의 테스트 케이스로 WorkflowRun의 상태 전이를 검증 (비록 실행 불가 상태이지만 테스트 설계 자체는 양호)

### 5.2 타입 안전성
- Branded Type으로 ID 혼용 방지 (`WorkflowId ≠ GitId ≠ McpServerId`)
- strict 모드에서 컴파일 에러 0개
- 외부 의존성을 uuid 1개로 최소화

### 5.3 이벤트 기반 설계
- 도메인 간 직접 참조 없이 이벤트로 통신
- `GitDeleted → WorkflowGitRefsUpdated` 등 깔끔한 이벤트 체인
- AggregateRoot 기반 이벤트 수집/발행 패턴

### 5.4 일관된 코드 컨벤션
- 파일: kebab-case, 클래스: PascalCase
- 팩토리 메서드 패턴 (`create`, `fromProps`) 일관 적용
- private 생성자 + readonly 필드로 불변성 보장

---

## 6. 종합 평가

| 영역 | 점수 | 비고 |
|------|:----:|------|
| **아키텍처 설계** | A- | 헥사고날 + DDD + 수직 슬라이스 — 교과서적이나 Adapter 미구현 |
| **도메인 모델링** | A | 상태 머신, 불변식, 이벤트 구동 설계 우수 |
| **타입 안전성** | B+ | Branded Type 우수하나 `as any` 캐스팅 존재 |
| **코드 품질** | B | lint error 4개, 미사용 import, 정규식 이슈 |
| **테스트** | D | 6/6 실패. 리팩터링 후 경로 미갱신으로 전멸 |
| **완성도** | C+ | 도메인만 존재, infra/presentation 비어 있음 |
| **코드 컨벤션** | A | 일관된 네이밍, 구조, 패턴 적용 |

### 종합 등급: **B**

---

## 7. 우선순위별 개선 사항

### 🔴 즉시 수정 (P0)

1. **테스트 import 경로 수정** — vitest.config.ts의 alias를 `@workflow-runtime/`, `@workflow/` 등으로 갱신하여 전체 테스트 복구
2. **`as any` 제거** — Report 생성 시 taskExecutionId/workExecutionId에 실제 유효한 ID를 할당하는 로직으로 변경

### 🟡 단기 개선 (P1)

3. **ESLint error 해결** — 미사용 import 제거, branch-name 정규식 수정
4. **StartWorkflowRunUseCase 분리** — Report 생성 로직을 Factory로 추출, Use Case를 오케스트레이션 역할로 단순화
5. **Application 레이어 테스트 추가** — Use Case 단위 테스트, 이벤트 핸들러 테스트

### 🟢 중기 개선 (P2)

6. **Adapter 구현** — 최소 1개 이상의 인메모리 Adapter 구현으로 통합 테스트 가능하게
7. **통합 테스트** — 워크플로우 생성 → 실행 → 완료까지의 E2E 시나리오
8. **방어적 복사 최적화** — ReadonlyArray 타입 반환으로 불필요한 스프레드 제거
9. **문서화** — 수직 슬라이스 리팩터링 이후의 아키텍처 문서 작성
